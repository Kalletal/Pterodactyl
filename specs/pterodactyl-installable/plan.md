# Implementation Plan: Pterodactyl SPK Installability

**Branch**: `[001-pterodactyl-installable]` | **Date**: 2025-11-13 | **Spec**: `specs/pterodactyl-installable/spec.md`  
**Input**: Feature specification from `/specs/pterodactyl-installable/spec.md`

> This template is filled in by `/speckit.plan` and is tailored to the Synology DS920+ Pterodactyl SPK.

## Summary

Ship a reproducible Synology `.spk` that installs the Pterodactyl panel + wings stack on a DS920+, bundling php83 (CLI + extensions: openssl, gd, mysql, PDO, mbstring, tokenizer, bcmath, xml, curl, zip), composer v2, and wiring Docker-compose services (panel, MariaDB ≥10.2, Redis, Apache-based web-serving) plus DSM service scripts. Build + runtime automation must come from `scripts/package/*`, `cross/`, and `spk/pterodactyl/**`, ensuring wizard/docs guide operators through prerequisites (Docker, php83, MariaDB, Redis).

## Technical Context (Fill, do not delete fields)

- **Target DSM/Arch**: `DSM 7.2 / geminilake (Synology arch id for DS920+)`
- **Build Toolchain**: `spksrc` via `scripts/package/*.sh` executed inside `synologytoolkit/dsm7.2:7.2-64570` (Docker on the build host)
- **Runtime Stack**: php83 CLI + required extensions, Apache HTTP server in the panel container, MariaDB 10.11 (≥10.2), Redis 7.2, Go-based Wings daemon, docker-compose orchestrated
- **External Dependencies**: Synology Docker package, php83 SPK, DSM reverse proxy for TLS, `curl`, `tar`, `unzip`, `git`, `composer v2`
- **Storage Layout Impacted**: `/var/packages/pterodactyl/target` (panel assets, docker-compose), `/var/packages/pterodactyl/var` (panel.env, data, logs), `/volume1/@appdata/pterodactyl` if backups later
- **Testing Surface**: `spk/scripts/verify-perms.sh`, docker-compose smoke test (panel, wings, MariaDB, Redis, Apache), `synopkg install --test` notes for DSM VM
- **Performance / Resource Goals**: <2 GB RAM idle, <70 % CPU on DS920+, disk footprint limited to data share (<10 GB after initial install)
- **Constraints**: No network egress from SPK build stage, secrets locked to `panel.env` (600) and wings config (640), docker group membership only for `sc-pterodactyl`

## Constitution Check (All MUST be addressed before Phase 0)

- **Synology Build Integrity**: Reuse `scripts/package/common.sh` + `build-*` helpers to clone spksrc, sync overlays (`cross/pterodactyl-panel`, `cross/wings`, `spk/pterodactyl`), and run `make spk/pterodactyl` with `ARCH=x86_64 TCVERSION=7.2`. Ensure php83 dependency declared in `SPK_DEPENDS`, composer v2 usage documented in `build-runtime-tools.sh`. Artifacts + checksums land in `dist/`.
- **Pterodactyl Fidelity**: Pin Panel `1.11.6` and Wings `1.11.5` (or newer if spec updates) in cross packages & docker images; adjust docker-compose to run Apache (the official panel image already serves via Apache, note in docs). Guarantee config templates surface PHP extension needs and DB/Redis minimum versions.
- **Security & Isolation**: `service-setup.sh` must create `/var/packages/pterodactyl/var` hierarchy, enforce 600/640 perms, and handle docker group membership. `dsm-control.sh` refuses to start without Docker/compose, logs to `var/pterodactyl.log`, and only exposes HTTP internally (DSM handles TLS).
- **Resource & Observability**: Document expected CPU/RAM/disk impact; ensure logging paths (panel logs, Compose logs, `var/pterodactyl.log`) are documented. Provide backup guidance (panel.env, mysql volume, redis data) and integrate with `spk/scripts/verify-perms.sh`.
- **Support & Upgrade Path**: `service_preupgrade`/`service_postupgrade` already snapshot/restore env + data; validate they also preserve Apache configs if changed. Release notes will list DSM/php83/Docker versions, required packages (`curl`, `tar`, `unzip`, `git`, composer v2). Physical DSM validation required before tagging.

## Project Structure

### Documentation (this feature)

```text
specs/pterodactyl-installable/
├── plan.md              # This file (/speckit.plan output)
├── research.md          # Phase 0 research (pending)
├── data-model.md        # Phase 1 output (pending)
├── quickstart.md        # Phase 1 output (pending)
├── contracts/           # Interfaces/API if needed (pending)
└── tasks.md             # Generated by /speckit.tasks
```

### Repository Topology (update with the dirs this feature touches)

```text
scripts/package/         # bootstrap + build helpers (common.sh, build-php-runtime, build-wings, build-spk, build-runtime-tools)
cross/                   # cross/pterodactyl-panel, cross/wings (versions, digests, PLIST)
spk/pterodactyl/         # Makefile, service scripts, docker-compose, env templates, wizard assets
spk/scripts/             # verify-perms / future validation scripts
docs/                    # operator guide, prerequisites, release notes
.specify/                # constitution-synced templates, plan/spec/tasks/checklist outputs
dist/, .build/           # generated artifacts (ignored from VCS)
```

Extend/adjust the tree to show new files or subdirectories you intend to add.

**Structure Decision**: Update existing directories above; add `specs/pterodactyl-installable/contracts/` (if API required) and `docs/pterodactyl/` for operator instructions. No new top-level projects created.

## Complexity Tracking

| Violation | Why Needed | Simpler Alternative Rejected Because |
|-----------|------------|-------------------------------------|
| *(none)* | | |
